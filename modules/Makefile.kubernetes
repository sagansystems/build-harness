CLUSTER_NAMESPACE ?=
CLUSTER_DOMAIN ?= mertslounge.ca
CLUSTER_BASTION ?= bastion.$(CLUSTER_NAMESPACE).$(CLUSTER_DOMAIN)
export CLUSTER_NAMESPACE

KUBERNETES_ANNOTATION ?= $(shell date -u +'%Y-%m-%d %H:%M:%SZ')
KUBERNETES_APP ?= $(subst -docker,,$(shell basename "`pwd`"))
KUBERNETES_RESOURCE_PATH ?= ./kubernetes
export KUBERNETES_APP

# Kubectl specific settings
KUBECTL ?= /opt/bin/kubectl
KUBECTL_SCHEMA_CACHE_DIR ?= --schema-cache-dir=.kube/cache
KUBECTL_SSH_CMD := ssh -A -o 'BatchMode=yes' -o 'LogLevel=error' -o 'StrictHostKeyChecking=no' -o 'UserKnownHostsFile=/dev/null'
# Optionally define an SSH command to use for tunneling kubectl commands
KUBECTL_SSH_TUNNEL ?= $(KUBECTL_SSH_USER)@$(CLUSTER_BASTION)

# Serial number optionally used for versioning; select the last 5 characters of unix time (24 character limit to resource names in k8s)
SERIAL ?= $(shell echo -n $$(date +%s) | tail -c 5)
export SERIAL

# Specify DEBUG=/dev/stderr to get useful output to stderr 
DEBUG ?= /dev/null

define envsubst 
	envsubst < "$(1)" | envsubst | tee $(DEBUG)
endef

define kubectl_apply
	@echo -e "INFO: Applying changes to $(KUBERNETES_APP) $(1) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(call envsubst,$(KUBERNETES_RESOURCE_PATH)/$(KUBERNETES_APP)-$(1).yml) | $(KUBECTL_CMD) apply $(KUBECTL_SCHEMA_CACHE_DIR) -f -
endef

define kubectl_create
	@echo -e "INFO: Creating $(KUBERNETES_APP) $(1) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(call envsubst,$(KUBERNETES_RESOURCE_PATH)/$(KUBERNETES_APP)-$(1).yml) | $(KUBECTL_CMD) create $(KUBECTL_SCHEMA_CACHE_DIR) -f -
endef

define kubectl_delete
	@echo -e "INFO: Deleteting $(KUBERNETES_APP) $(1) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(call envsubst,$(KUBERNETES_RESOURCE_PATH)/$(KUBERNETES_APP)-$(1).yml) | $(KUBECTL_CMD) delete --ignore-not-found=true -f -
endef

ifeq ($(CIRCLECI),true)
  KUBECTL_SSH_CMD += -i '$(HOME)/.ssh/id_circleci_github'
  KUBECTL_SSH_USER ?= saganbot
  CLUSTER_NAMESPACE ?= $(CIRCLE_BRANCH)
endif

ifeq ($(strip $(KUBECTL_SSH_USER)),)
  # Guess their github username
	KUBECTL_SSH_USER = $(shell ssh git@github.com 2>&1 | grep 'successfully authenticated' | cut -d' ' -f2 | cut -d'!' -f1)
endif

# Add the SSH endpoint to the command; everything after the host is expected to be a remote command
KUBECTL_SSH_CMD += $(KUBECTL_SSH_TUNNEL)

KUBECTL_CMD ?= $(KUBECTL_SSH_CMD) "$(KUBECTL)" --logtostderr=true --insecure-skip-tls-verify=true

#
# Reference Docs:
#  - https://cloud.google.com/container-engine/docs/kubectl/
#
## Display info about the kubernetes setup
kubernetes\:info:
	@echo -e "Cluster Namespace: $(call yellow,$(CLUSTER_NAMESPACE))"
	@echo -e "Cluster Domain: $(call yellow,$(CLUSTER_DOMAIN))"
	@echo -e "SSH Tunnel: $(call yellow,$(KUBECTL_SSH_TUNNEL))"
	@echo -e "SSH User: $(call yellow,$(KUBECTL_SSH_USER))"

# (private) Delete a service
kubernetes\:delete-service:
	$(call kubectl_delete,service)

# (private) Update service or create, if necessary
kubernetes\:apply-service:
	$(call kubectl_apply,service)

# (private) Delete a controller
kubernetes\:delete-controller:
	$(call kubectl_delete,controller)

# (private) Update a controller or create, if necessary
kubernetes\:apply-controller:
	$(call kubectl_apply,controller)

# (private) Delete a deploymentt
kubernetes\:delete-deployment:
	$(call kubectl_delete,deployment)

# (private) Update existing deployment or create, if necessary
kubernetes\:apply-deployment:
	$(call kubectl_apply,deployment)

## Rollback to previous deployment
kubernetes\:undo-deployment:
	@echo -e "INFO: Rolling back to previous deployment of $(KUBERNETES_APP) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(KUBECTL_CMD) rollout undo deployment $(KUBERNETES_APP)

## Deploy everything that needs to be deployed; notify datadog
kubernetes\:deploy:
	@echo -e "INFO: Deploying $(KUBERNETES_APP) resources on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	$(NOTIFY_STARTING)
	@[ ! -f "$(KUBERNETES_RESOURCE_PATH)/$(KUBERNETES_APP)-deployment.yml" ] || $(SELF) kubernetes:apply-deployment || $(NOTIFY_FAILURE)
	@[ ! -f "$(KUBERNETES_RESOURCE_PATH)/$(KUBERNETES_APP)-controller.yml" ] || $(SELF) kubernetes:apply-controller || $(NOTIFY_FAILURE)
	@[ ! -f "$(KUBERNETES_RESOURCE_PATH)/$(KUBERNETES_APP)-service.yml" ] || $(SELF) kubernetes:apply-service || $(NOTIFY_FAILURE)
	$(NOTIFY_SUCCESS)

## List deployed replication controllers for app
kubernetes\:list-rc:
	@echo -e "INFO: Listing replication controllers for $(KUBERNETES_APP) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(KUBECTL_CMD) get rc -L tag --selector app=$(KUBERNETES_APP)

## List deployed replica sets for app
kubernetes\:list-rs:
	@echo -e "INFO: Listing replica sets for $(KUBERNETES_APP) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(KUBECTL_CMD) get rs -L tag --selector app=$(KUBERNETES_APP) | grep -Ev '\s+0\s+0\s+'

## List deployed pods for app
kubernetes\:list-pods:
	@echo -e "INFO: Listing pods for $(KUBERNETES_APP) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(KUBECTL_CMD) get pods -L tag --selector app=$(KUBERNETES_APP)

## List deployed services
kubernetes\:list-svc:
	@echo -e "INFO: Listing services on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(KUBECTL_CMD) get svc

## Show deployment history
kubernetes\:deployment-history:
	@echo -e "INFO: Listing deployments of $(KUBERNETES_APP) on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(KUBECTL_CMD) rollout history deployment $(KUBERNETES_APP)

## List everything that's deployed
kubernetes\:list-deployments:
	@echo -e "INFO: Listing deployments on cluster $(call yellow,$(CLUSTER_NAMESPACE))..."
	@$(KUBECTL_CMD) get deployments -L tag


